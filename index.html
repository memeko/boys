<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–∞—Ä—Ç–æ—á–∫–∏-–∫–≤–∏–∑ ‚Äî ¬´–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –º–∞–ª—å—á–∏–∫–æ–≤¬ª</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg: #0b1020;
      --bg2:#0f1733;
      --card:#121b38cc;
      --card2:#101a36f2;
      --text:#eef2ff;
      --muted:#b7c2ff;
      --accent:#ffd37a;   /* —Ç—ë–ø–ª–∞—è ‚Äú–±—É–º–∞–∂–Ω–∞—è‚Äù –Ω–æ—Ç–∞ */
      --accent2:#7ad7ff;  /* —Ö–æ–ª–æ–¥–Ω—ã–π ‚Äú–Ω–∞—É—á–Ω—ã–π‚Äù –∞–∫—Ü–µ–Ω—Ç */
      --good:#59d38c;
      --bad:#ff6b7a;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --radius: 22px;
      --ring: 0 0 0 3px rgba(122,215,255,.25);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans", Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f7ff;
        --bg2:#eef2ff;
        --card:#ffffffcc;
        --card2:#ffffff;
        --text:#0c1633;
        --muted:#4b5a86;
        --shadow: 0 18px 55px rgba(6,20,60,.15);
        --ring: 0 0 0 3px rgba(40,110,255,.18);
      }
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(122,215,255,.22), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(255,211,122,.20), transparent 60%),
        radial-gradient(900px 700px at 50% 100%, rgba(179,122,255,.16), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      min-height:100svh;
      display:flex;
      align-items:stretch;
      justify-content:center;
      padding:24px 14px;
    }

    .app{
      width:min(980px, 100%);
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    header{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-radius:var(--radius);
      background:linear-gradient(135deg, rgba(255,211,122,.14), rgba(122,215,255,.12));
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.12);
      backdrop-filter: blur(10px);
    }

    .brand{
      display:flex; flex-direction:column; gap:2px;
      min-width:0;
    }
    .brand .kicker{
      font-size:12px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .badge{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:var(--text);
      white-space:nowrap;
    }
    .title{
      font-size:18px;
      font-weight:760;
      line-height:1.2;
      margin:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .sub{
      margin:0;
      font-size:13px;
      color:var(--muted);
      line-height:1.25;
    }

    .actions{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }

    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.10);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      font-weight:650;
      cursor:pointer;
      transition:transform .06s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .btn:hover{ background:rgba(255,255,255,.14); }
    .btn:active{ transform:translateY(1px); }
    .btn:focus-visible{ outline:none; box-shadow:var(--ring); }

    .btn.primary{
      background:linear-gradient(135deg, rgba(255,211,122,.28), rgba(122,215,255,.18));
      border-color:rgba(255,211,122,.28);
    }

    main{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:14px;
      align-items:stretch;
    }

    @media (max-width: 860px){
      main{ grid-template-columns:1fr; }
      .title{ white-space:normal; }
    }

    .card{
      border-radius:var(--radius);
      background:linear-gradient(180deg, var(--card), var(--card2));
      box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.12);
      padding:18px;
      backdrop-filter: blur(10px);
    }

    .metaRow{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      flex-wrap:wrap;
      margin-bottom:12px;
    }

    .progress{
      display:flex; flex-direction:column; gap:6px;
      min-width:220px;
    }
    .progress .line{
      height:10px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .progress .bar{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg, rgba(122,215,255,.9), rgba(255,211,122,.9));
      transition: width .35s ease;
    }
    .progress .txt{
      font-family:var(--mono);
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }

    .scoreBox{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      font-family:var(--mono);
      color:var(--muted);
      font-size:12px;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.08);
      color:var(--text);
    }

    .question{
      font-size:18px;
      line-height:1.35;
      margin:0 0 12px 0;
      font-weight:720;
    }

    .options{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
      margin-top:10px;
    }
    .opt{
      text-align:left;
      width:100%;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.16);
      background:rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      display:flex;
      gap:10px;
      align-items:flex-start;
    }
    .opt:hover{ background:rgba(255,255,255,.10); }
    .opt:active{ transform:translateY(1px); }
    .opt:focus-visible{ outline:none; box-shadow:var(--ring); }
    .opt[disabled]{ opacity:.65; cursor:not-allowed; }

    .opt .idx{
      font-family:var(--mono);
      font-weight:800;
      opacity:.75;
      min-width:22px;
      margin-top:1px;
    }
    .opt.good{
      border-color:rgba(89,211,140,.55);
      background:rgba(89,211,140,.16);
    }
    .opt.bad{
      border-color:rgba(255,107,122,.55);
      background:rgba(255,107,122,.14);
    }

    .feedback{
      margin-top:12px;
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.06);
    }
    .feedback .dot{
      width:10px; height:10px;
      border-radius:50%;
      margin-top:4px;
      flex:0 0 auto;
      background:var(--accent2);
    }
    .feedback.good .dot{ background:var(--good); }
    .feedback.bad .dot{ background:var(--bad); }
    .feedback p{
      margin:0;
      color:var(--muted);
      line-height:1.35;
      font-size:13px;
    }

    .side .h{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.02em;
      text-transform:uppercase;
      color:var(--muted);
    }

    .side a{
      color:var(--text);
      text-decoration:none;
      border-bottom:1px dashed rgba(255,255,255,.35);
    }
    .side a:hover{ border-bottom-color:transparent; }

    .small{
      font-size:13px;
      color:var(--muted);
      line-height:1.45;
      margin:0;
    }

    .kbd{
      font-family:var(--mono);
      font-size:12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      color:var(--text);
    }

    .error{
      border-color: rgba(255,107,122,.45);
      background: rgba(255,107,122,.10);
      padding:12px;
      border-radius:16px;
      color:var(--text);
      font-size:13px;
      line-height:1.45;
    }

    footer{
      margin-top:4px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      line-height:1.35;
    }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="–ò–≥—Ä–∞ —Å –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏-–≤–æ–ø—Ä–æ—Å–∞–º–∏">
    <header>
      <div class="brand">
        <div class="kicker">
          <span class="badge">–∫–∞—Ä—Ç–æ—á–∫–∏-–∫–≤–∏–∑</span>
          <span class="badge">–ø–æ –∫–Ω–∏–≥–µ</span>
        </div>
        <h1 class="title">¬´–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –º–∞–ª—å—á–∏–∫–æ–≤. –¢–æ–Ω–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è —Å—ã–Ω–æ–≤–µ–π¬ª</h1>
        <p class="sub">–ò—Å—Ç–æ—á–Ω–∏–∫ –∫–∞—Ä—Ç–æ—á–µ–∫: –≤–∞—à CSV-—Ñ–∞–π–ª + —Å—Å—ã–ª–∫–∞ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏.</p>
      </div>
      <div class="actions">
        <button class="btn" id="btnShuffle" title="–ü–µ—Ä–µ–º–µ—à–∞—Ç—å –ø–æ—Ä—è–¥–æ–∫ –≤–æ–ø—Ä–æ—Å–æ–≤">üîÄ –ü–µ—Ä–µ–º–µ—à–∞—Ç—å</button>
        <button class="btn primary" id="btnRestart" title="–ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ">‚Üª –ó–∞–Ω–æ–≤–æ</button>
      </div>
    </header>

    <main>
      <section class="card" aria-live="polite">
        <div class="metaRow">
          <div class="progress" aria-label="–ü—Ä–æ–≥—Ä–µ—Å—Å">
            <div class="line" aria-hidden="true"><div class="bar" id="bar"></div></div>
            <div class="txt">
              <span id="posTxt">‚Äî</span>
              <span id="deckTxt">‚Äî</span>
            </div>
          </div>
          <div class="scoreBox" aria-label="–°—á—ë—Ç">
            <span class="pill" id="scorePill">–û—á–∫–∏: 0</span>
            <span class="pill" id="streakPill">–°–µ—Ä–∏—è: 0</span>
          </div>
        </div>

        <p class="question" id="q">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤‚Ä¶</p>
        <div class="options" id="opts" role="list"></div>

        <div id="fb" class="feedback" style="display:none;">
          <div class="dot" aria-hidden="true"></div>
          <p id="fbText"></p>
        </div>

        <div id="err" class="error" style="display:none;"></div>

        <div class="metaRow" style="margin-top:14px;">
          <span class="small">
            –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã: <span class="kbd">1</span>‚Äì<span class="kbd">4</span> –≤—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç,
            <span class="kbd">Enter</span> –¥–∞–ª—å—à–µ.
          </span>
          <button class="btn" id="btnNext" disabled title="–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å">‚Üí –î–∞–ª—å—à–µ</button>
        </div>
      </section>

      <aside class="card side">
        <p class="h">–°–ø—Ä–∞–≤–∫–∞</p>
        <p class="small" style="margin-bottom:10px;">
          –≠—Ç–∞ –º–∏–Ω–∏-–∏–≥—Ä–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤ (–æ–¥–∏–Ω –≤–µ—Ä–Ω—ã–π).
          –í–∏–∑—É–∞–ª—å–Ω–∞—è ‚Äú—Ä–∞–º–∫–∞‚Äù –ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ –∫–Ω–∏–≥–µ –∏ –Ω–µ –º–∞—Å–∫–∏—Ä—É–µ—Ç—Å—è –ø–æ–¥ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ ‚Äî –ø—Ä–æ—Å—Ç–æ –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è –æ—Ç—Å—ã–ª–∫–∞.
        </p>

        <p class="small" style="margin:0 0 10px 0;">
          –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–Ω–∏–≥–∏ –Ω–∞ —Å–∞–π—Ç–µ –∏–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–∞:
          <br />
          <a href="https://pilotlz.ru/books/309/11037/" target="_blank" rel="noopener noreferrer">
            pilotlz.ru/books/309/11037/
          </a>
        </p>

        <p class="h" style="margin-top:14px;">–¢–µ—Ö—á–∞—Å—Ç—å</p>
        <p class="small" style="margin-bottom:10px;">
          –§–∞–π–ª <span class="kbd">flashcards.csv</span> –¥–æ–ª–∂–µ–Ω –ª–µ–∂–∞—Ç—å —Ä—è–¥–æ–º —Å <span class="kbd">index.html</span>.
          CSV –æ–∂–∏–¥–∞–µ—Ç—Å—è –∫–∞–∫ –¥–≤–µ –∫–æ–ª–æ–Ω–∫–∏: <b>–≤–æ–ø—Ä–æ—Å</b> –∏ <b>–≤–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç</b>.
        </p>

        <p class="small" style="margin:0;">
          –ï—Å–ª–∏ CSV –Ω–µ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –Ω–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è —Ñ–∞–π–ª–∞), –∏–≥—Ä–∞ –≤–∫–ª—é—á–∏—Ç –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π –¥–µ–º–æ-–Ω–∞–±–æ—Ä.
        </p>
      </aside>
    </main>

    <footer>
      –ö–∞—Ä—Ç–æ—á–∫–∏ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω—ã –∏–∑ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è. –û—Ç—Å—ã–ª–∫–∞ –∫ –∫–Ω–∏–≥–µ ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è: ¬´–†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –º–∞–ª—å—á–∏–∫–æ–≤. –¢–æ–Ω–∫–æ–µ –∏—Å–∫—É—Å—Å—Ç–≤–æ –≤–æ—Å–ø–∏—Ç–∞–Ω–∏—è —Å—ã–Ω–æ–≤–µ–π¬ª.
    </footer>
  </div>

  <!-- CSV parser (tiny and reliable) -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    // --- Config ---
    const CSV_FILE = "flashcards.csv";
    const CHOICES = 4;

    // --- State ---
    let deck = [];
    let order = [];
    let idx = 0;
    let locked = false;
    let answered = false;

    let score = 0;
    let streak = 0;

    // --- Elements ---
    const elQ = document.getElementById("q");
    const elOpts = document.getElementById("opts");
    const elFb = document.getElementById("fb");
    const elFbText = document.getElementById("fbText");
    const elErr = document.getElementById("err");
    const elNext = document.getElementById("btnNext");
    const elShuffle = document.getElementById("btnShuffle");
    const elRestart = document.getElementById("btnRestart");
    const elBar = document.getElementById("bar");
    const elPos = document.getElementById("posTxt");
    const elDeckTxt = document.getElementById("deckTxt");
    const elScore = document.getElementById("scorePill");
    const elStreak = document.getElementById("streakPill");

    // --- Demo fallback (–µ—Å–ª–∏ CSV –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è) ---
    const demo = [
      { q: "–ü—Ä–∏–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: —á—Ç–æ –≤–∞–∂–Ω–µ–µ –≤—Å–µ–≥–æ –≤ —Ä–∞–∑–≥–æ–≤–æ—Ä–µ —Å –ø–æ–¥—Ä–æ—Å—Ç–∫–æ–º?", a: "–†–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å –∏ —É–≤–∞–∂–µ–Ω–∏–µ –∫ –µ–≥–æ –ø–µ—Ä–µ–∂–∏–≤–∞–Ω–∏—è–º." },
      { q: "–ü—Ä–∏–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: —á—Ç–æ –ø–æ–º–æ–≥–∞–µ—Ç –º–∞–ª—å—á–∏–∫–∞–º —É—á–∏—Ç—å—Å—è –ø—Ä–æ—Å–∏—Ç—å –ø–æ–º–æ—â—å?", a: "–ë–µ–∑–æ–ø–∞—Å–Ω–∞—è —Å—Ä–µ–¥–∞ –±–µ–∑ —Å—Ç—ã–¥–∞ –∏ —è—Ä–ª—ã–∫–æ–≤." },
      { q: "–ü—Ä–∏–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: –ø–æ—á–µ–º—É –≤–∞–∂–Ω–æ –æ–±—Å—É–∂–¥–∞—Ç—å —á—É–≤—Å—Ç–≤–∞, –∞ –Ω–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å—Ç—É–ø–∫–∏?", a: "–ü–æ—Ç–æ–º—É —á—Ç–æ —á—É–≤—Å—Ç–≤–∞ —É–ø—Ä–∞–≤–ª—è—é—Ç —Ä–µ—à–µ–Ω–∏—è–º–∏ —Å–∏–ª—å–Ω–µ–µ, —á–µ–º –∫–∞–∂–µ—Ç—Å—è." },
      { q: "–ü—Ä–∏–º–µ—Ä –≤–æ–ø—Ä–æ—Å–∞: —á—Ç–æ –¥–µ–ª–∞—Ç—å –≤–º–µ—Å—Ç–æ –º–æ—Ä–∞–ª–∏–∑–∞—Ü–∏–∏?", a: "–°–ª—É—à–∞—Ç—å, —É—Ç–æ—á–Ω—è—Ç—å, –∑–∞–¥–∞–≤–∞—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞—Ç—å—Å—è." }
    ];

    // --- Utilities ---
    function shuffle(arr){
      const a = arr.slice();
      for (let i = a.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }

    function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }

    function setError(msg){
      if (!msg){
        elErr.style.display = "none";
        elErr.textContent = "";
        return;
      }
      elErr.style.display = "block";
      elErr.textContent = msg;
    }

    function setFeedback(kind, msg){
      elFb.style.display = "flex";
      elFb.classList.remove("good","bad");
      if (kind) elFb.classList.add(kind);
      elFbText.textContent = msg;
    }

    function clearFeedback(){
      elFb.style.display = "none";
      elFb.classList.remove("good","bad");
      elFbText.textContent = "";
    }

    function normalizeRow(row){
      // row may be array or object; we want 2 fields
      let q = "", a = "";
      if (Array.isArray(row)){
        q = String(row[0] ?? "").trim();
        a = String(row[1] ?? "").trim();
      } else if (row && typeof row === "object"){
        const keys = Object.keys(row);
        q = String(row[keys[0]] ?? "").trim();
        a = String(row[keys[1]] ?? "").trim();
      }
      return { q, a };
    }

    function buildOrder(){
      order = shuffle([...Array(deck.length).keys()]);
      idx = 0;
      answered = false;
      locked = false;
      clearFeedback();
      elNext.disabled = true;
      render();
    }

    function pickChoices(correctAnswer){
      const allAnswers = deck.map(x => x.a).filter(Boolean);
      const pool = allAnswers.filter(a => a !== correctAnswer);
      const picks = shuffle(pool).slice(0, Math.max(0, CHOICES - 1));
      const choices = shuffle([correctAnswer, ...picks]).slice(0, CHOICES);
      // if not enough unique answers, pad with correct (rare edge-case)
      while (choices.length < CHOICES) choices.push(correctAnswer);
      return choices;
    }

    function updateHUD(){
      const total = order.length || 1;
      const pos = clamp(idx + 1, 1, total);
      elPos.textContent = `–í–æ–ø—Ä–æ—Å ${pos} –∏–∑ ${total}`;
      elDeckTxt.textContent = `${deck.length} –∫–∞—Ä—Ç–æ—á–µ–∫ –≤ –Ω–∞–±–æ—Ä–µ`;
      elScore.textContent = `–û—á–∫–∏: ${score}`;
      elStreak.textContent = `–°–µ—Ä–∏—è: ${streak}`;
      elBar.style.width = `${Math.round((pos / total) * 100)}%`;
    }

    function render(){
      setError("");
      updateHUD();

      if (!deck.length){
        elQ.textContent = "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–≥—Ä—ã.";
        elOpts.innerHTML = "";
        return;
      }

      const card = deck[order[idx]];
      elQ.textContent = card.q;

      elOpts.innerHTML = "";
      clearFeedback();
      elNext.disabled = true;
      answered = false;
      locked = false;

      const choices = pickChoices(card.a);
      choices.forEach((text, i) => {
        const btn = document.createElement("button");
        btn.className = "opt";
        btn.type = "button";
        btn.setAttribute("role", "listitem");
        btn.dataset.index = String(i);
        btn.dataset.value = text;

        const idxSpan = document.createElement("span");
        idxSpan.className = "idx";
        idxSpan.textContent = `${i+1}.`;

        const tSpan = document.createElement("span");
        tSpan.textContent = text;

        btn.appendChild(idxSpan);
        btn.appendChild(tSpan);

        btn.addEventListener("click", () => choose(btn));
        elOpts.appendChild(btn);
      });
    }

    function choose(btn){
      if (locked || answered) return;
      locked = true;

      const selected = btn.dataset.value;
      const card = deck[order[idx]];
      const correct = card.a;

      const optionButtons = [...elOpts.querySelectorAll(".opt")];
      optionButtons.forEach(b => b.disabled = true);

      // Mark correct & incorrect
      optionButtons.forEach(b => {
        if (b.dataset.value === correct) b.classList.add("good");
      });
      if (selected !== correct) btn.classList.add("bad");

      answered = true;
      elNext.disabled = false;

      if (selected === correct){
        score += 1;
        streak += 1;
        setFeedback("good", "–í–µ—Ä–Ω–æ. –ù–µ –º–∞–≥–∏—è, –∞ –∞–∫–∫—É—Ä–∞—Ç–Ω–∞—è –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —Å–º—ã—Å–ª—É.");
      } else {
        streak = 0;
        setFeedback("bad", `–ù–µ–≤–µ—Ä–Ω–æ. –í–µ—Ä–Ω—ã–π –æ—Ç–≤–µ—Ç: ¬´${correct}¬ª.`);
      }

      updateHUD();
      locked = false;
    }

    function next(){
      if (!answered) return;
      if (idx < order.length - 1){
        idx += 1;
        render();
      } else {
        // —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —ç–∫—Ä–∞–Ω
        elQ.textContent = "–§–∏–Ω–∏—à! üéØ";
        elOpts.innerHTML = "";
        elNext.disabled = true;

        const total = order.length;
        const pct = Math.round((score / total) * 100);

        setFeedback(null, `–†–µ–∑—É–ª—å—Ç–∞—Ç: ${score}/${total} (${pct}%). –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–Ω–æ–≤–æ¬ª, —á—Ç–æ–±—ã —Å—ã–≥—Ä–∞—Ç—å –µ—â—ë —Ä–∞–∑.`);
      }
      updateHUD();
    }

    // --- Load CSV ---
    async function loadCSV(){
      try{
        const resp = await fetch(CSV_FILE, { cache: "no-store" });
        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
        const text = await resp.text();

        const parsed = Papa.parse(text, {
          skipEmptyLines: true
        });

        if (!parsed.data || parsed.data.length < 2){
          throw new Error("CSV –≤—ã–≥–ª—è–¥–∏—Ç –ø—É—Å—Ç—ã–º –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–º.");
        }

        // Support cases where first row is mistakenly treated as header in some exports.
        // We treat every row as [question, answer] if it has >=2 columns.
        const rows = parsed.data
          .map(r => normalizeRow(r))
          .filter(r => r.q && r.a);

        if (rows.length < 2){
          throw new Error("–ù–µ —É–¥–∞–ª–æ—Å—å –∏–∑–≤–ª–µ—á—å –ø–∞—Ä—ã ¬´–≤–æ–ø—Ä–æ—Å‚Äì–æ—Ç–≤–µ—Ç¬ª –∏–∑ CSV.");
        }

        deck = rows;
      } catch (e){
        deck = demo;
        setError(
          `–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å ¬´${CSV_FILE}¬ª. –í–∫–ª—é—á—ë–Ω –¥–µ–º–æ-–Ω–∞–±–æ—Ä.\n` +
          `–ü—Ä–∏—á–∏–Ω–∞: ${String(e.message || e)}\n\n` +
          `–ü—Ä–æ–≤–µ—Ä—å—Ç–µ: —Ñ–∞–π–ª —Ä—è–¥–æ–º —Å index.html –∏ –∑–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä (–∞ –Ω–µ file://).`
        );
      } finally {
        buildOrder();
      }
    }

    // --- Events ---
    elNext.addEventListener("click", next);
    elRestart.addEventListener("click", () => {
      score = 0; streak = 0;
      buildOrder();
    });
    elShuffle.addEventListener("click", () => {
      buildOrder();
    });

    // Keyboard: 1-4 choose, Enter next
    window.addEventListener("keydown", (ev) => {
      const k = ev.key;
      if (k >= "1" && k <= "4"){
        const i = Number(k) - 1;
        const btn = elOpts.querySelector(`.opt[data-index="${i}"]`);
        if (btn && !btn.disabled) btn.click();
      }
      if (k === "Enter"){
        if (!elNext.disabled) next();
      }
    });

    loadCSV();
  </script>
</body>
</html>
